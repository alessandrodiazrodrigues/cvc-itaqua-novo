<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Dashboard Controles de Embarques - CVC Itaqua (CORRIGIDO)</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --cvc-azul: #003399;
            --cvc-amarelo: #FFD700;
            --cvc-verde: #00A859;
            --cvc-azul-claro: #4A90E2;
            --cvc-azul-escuro: #002266;
        }
        
        body {
            background: linear-gradient(135deg, var(--cvc-azul) 0%, var(--cvc-azul-claro) 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            margin: 20px auto;
            max-width: 1400px;
        }
        
        .header-section {
            background: linear-gradient(135deg, var(--cvc-azul) 0%, var(--cvc-azul-escuro) 100%);
            color: white;
            padding: 30px;
            border-radius: 20px 20px 0 0;
            position: relative;
            overflow: hidden;
        }
        
        .alert-fix {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border-left: 4px solid #20c997;
            color: white;
            font-weight: 600;
        }
        
        .debug-info {
            background: #000;
            color: #00ff00;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <div class="header-section">
                <div class="text-center">
                    <h1 class="mb-0">Dashboard Embarques - CORRIGIDO v8.0</h1>
                    <p class="mb-0">L√≥gica de processamento otimizada para encontrar TODOS os embarques v√°lidos</p>
                </div>
            </div>
            
            <!-- Alert de Corre√ß√£o -->
            <div class="alert alert-fix">
                <i class="fas fa-tools"></i>
                <strong>CORRE√á√ÉO APLICADA:</strong> 
                Otimizei a l√≥gica para processar TODOS os 1594 registros e encontrar os embarques das linhas 451-587.
                O sistema agora deve classificar corretamente check-ins, confer√™ncias e p√≥s-vendas.
            </div>
            
            <!-- Debug Info -->
            <div class="p-4">
                <h4><i class="fas fa-bug text-info"></i> Processamento Otimizado</h4>
                <div id="debug-info" class="debug-info">Aguardando processamento dos dados...</div>
                
                <button class="btn btn-primary me-2" onclick="testarProcessamento()">
                    <i class="fas fa-sync"></i> Testar Nova L√≥gica
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyAwCvYevic73muFTSoYWkJS9YxdmwmboSaJuxRRG0Cf3uJr54yQfHnvOrPn1ufM5YMFw/exec';
        
        console.log('üöÄ Dashboard Embarques v8.0 - L√ìGICA CORRIGIDA');
        
        let dadosOriginais = [];
        
        // ================================================================================
        // üîß NOVA L√ìGICA DE PROCESSAMENTO - CORRIGIDA
        // ================================================================================
        
        function processarEmbarquesCorrigido(embarquesOriginais) {
            console.log('‚öôÔ∏è NOVA L√ìGICA: Processando embarques corrigidos...');
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            const embarquesProcessados = [];
            let stats = {
                totalOriginais: embarquesOriginais.length,
                comDataValida: 0,
                conferencia: 0,
                checkin: 0,
                posvenda: 0,
                ignorados: 0,
                detalhesIgnorados: {}
            };
            
            embarquesOriginais.forEach((embarque, index) => {
                try {
                    // üéØ PRIORIZAR CAMPO dataIda (mais confi√°vel)
                    let dataIda = null;
                    
                    if (embarque.dataIda) {
                        dataIda = parseDataOtimizada(embarque.dataIda);
                    }
                    
                    // Se n√£o achou no dataIda, tentar outros campos
                    if (!dataIda && embarque.dataCadastro) {
                        dataIda = parseDataOtimizada(embarque.dataCadastro);
                    }
                    
                    if (!dataIda && embarque.timestamp) {
                        dataIda = parseDataOtimizada(embarque.timestamp);
                    }
                    
                    // Se ainda n√£o achou data v√°lida, ignorar
                    if (!dataIda) {
                        stats.ignorados++;
                        const motivo = embarque.dataIda ? 'data_invalida' : 'sem_data';
                        stats.detalhesIgnorados[motivo] = (stats.detalhesIgnorados[motivo] || 0) + 1;
                        return;
                    }
                    
                    // ‚úÖ DATA V√ÅLIDA ENCONTRADA
                    stats.comDataValida++;
                    
                    const diasParaIda = Math.ceil((dataIda - hoje) / (1000 * 60 * 60 * 24));
                    
                    // üéØ L√ìGICA DE CLASSIFICA√á√ÉO CORRIGIDA:
                    let tipoControle = null;
                    
                    // Check-in: -1 a +2 dias (inclui hoje, ontem, amanh√£)
                    if (diasParaIda >= -1 && diasParaIda <= 2) {
                        tipoControle = 'checkin';
                        stats.checkin++;
                    }
                    // Confer√™ncia: +3 a +30 dias (per√≠odo estendido)
                    else if (diasParaIda >= 3 && diasParaIda <= 30) {
                        tipoControle = 'conferencia';
                        stats.conferencia++;
                    }
                    // P√≥s-vendas: -30 a -2 dias (voltou h√° poucos dias)
                    else if (diasParaIda >= -30 && diasParaIda <= -2) {
                        // Verificar se √© p√≥s-venda (precisa de data de volta)
                        let dataVolta = parseDataOtimizada(embarque.dataVolta);
                        if (dataVolta) {
                            const diasAposVolta = Math.ceil((hoje - dataVolta) / (1000 * 60 * 60 * 24));
                            if (diasAposVolta >= 2 && diasAposVolta <= 30) {
                                tipoControle = 'posvenda';
                                stats.posvenda++;
                            }
                        }
                    }
                    
                    // Se tem tipo de controle, adicionar √† lista
                    if (tipoControle) {
                        const embarqueProcessado = {
                            ...embarque,
                            id: embarque.id || (index + 1).toString(),
                            dataIda: dataIda,
                            diasParaIda: diasParaIda,
                            tipoControle: tipoControle,
                            // Normalizar campos
                            nomeCliente: embarque.nomeCliente || 'N/A',
                            cpfCliente: embarque.cpfCliente || 'N/A',
                            vendedor: embarque.vendedor || 'N/A',
                            observacoes: embarque.observacoes || '',
                            // Status dos controles
                            conferenciaFeita: false,
                            checkinFeito: false,
                            posVendaFeito: false
                        };
                        
                        embarquesProcessados.push(embarqueProcessado);
                    } else {
                        stats.ignorados++;
                        stats.detalhesIgnorados['fora_periodo'] = (stats.detalhesIgnorados['fora_periodo'] || 0) + 1;
                    }
                    
                } catch (error) {
                    console.error(`‚ùå Erro ao processar embarque ${index + 1}:`, error);
                    stats.ignorados++;
                    stats.detalhesIgnorados['erro_processamento'] = (stats.detalhesIgnorados['erro_processamento'] || 0) + 1;
                }
            });
            
            // üéØ ORDENAR POR PRIORIDADE E DATA
            embarquesProcessados.sort((a, b) => {
                // Prioridade: check-in > confer√™ncia > p√≥s-venda
                const prioridade = { checkin: 1, conferencia: 2, posvenda: 3 };
                
                if (a.tipoControle !== b.tipoControle) {
                    return prioridade[a.tipoControle] - prioridade[b.tipoControle];
                }
                
                // Dentro do mesmo tipo, ordenar por data mais pr√≥xima
                return a.dataIda - b.dataIda;
            });
            
            console.log('üìä ESTAT√çSTICAS DO PROCESSAMENTO CORRIGIDO:');
            console.log(`   Total originais: ${stats.totalOriginais}`);
            console.log(`   Com data v√°lida: ${stats.comDataValida}`);
            console.log(`   Check-ins: ${stats.checkin}`);
            console.log(`   Confer√™ncias: ${stats.conferencia}`);
            console.log(`   P√≥s-vendas: ${stats.posvenda}`);
            console.log(`   Ignorados: ${stats.ignorados}`);
            console.log(`   Total processados: ${embarquesProcessados.length}`);
            console.log(`   Taxa aproveitamento: ${((embarquesProcessados.length / stats.totalOriginais) * 100).toFixed(1)}%`);
            
            return { embarques: embarquesProcessados, stats: stats };
        }
        
        function parseDataOtimizada(dateValue) {
            if (!dateValue) return null;
            
            try {
                // Se j√° √© uma data v√°lida
                if (dateValue instanceof Date && !isNaN(dateValue.getTime())) {
                    return dateValue;
                }
                
                // String de data
                if (typeof dateValue === 'string') {
                    dateValue = dateValue.trim();
                    
                    // Rejeitar valores que n√£o s√£o datas
                    if (dateValue === 'true' || 
                        dateValue === 'false' || 
                        dateValue === 'ANTIGO' ||
                        dateValue.includes('RT - ') ||
                        dateValue.includes('Check') ||
                        dateValue.length < 8 ||
                        !dateValue.match(/\d/)) {
                        return null;
                    }
                    
                    // Parse ISO primeiro
                    let date = new Date(dateValue);
                    if (!isNaN(date.getTime()) && 
                        date.getFullYear() > 2020 && 
                        date.getFullYear() < 2030) {
                        return date;
                    }
                    
                    // Formato brasileiro DD/MM/YYYY
                    const brMatch = dateValue.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                    if (brMatch) {
                        date = new Date(brMatch[3], brMatch[2] - 1, brMatch[1]);
                        if (!isNaN(date.getTime())) {
                            return date;
                        }
                    }
                }
                
                return null;
                
            } catch (error) {
                return null;
            }
        }
        
        // ================================================================================
        // üß™ FUN√á√ÉO DE TESTE
        // ================================================================================
        
        async function testarProcessamento() {
            const debugDiv = document.getElementById('debug-info');
            debugDiv.textContent = 'Carregando dados para teste...';
            
            try {
                // Carregar dados da API
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'text/plain;charset=utf-8',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ action: 'listar_embarques' })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    dadosOriginais = result.data.embarques || [];
                    console.log(`‚úÖ ${dadosOriginais.length} registros carregados`);
                    
                    // Aplicar nova l√≥gica
                    const resultadoProcessamento = processarEmbarquesCorrigido(dadosOriginais);
                    
                    // Mostrar resultados no debug
                    let debugText = `
================================================================================
üéØ RESULTADO DO PROCESSAMENTO CORRIGIDO
================================================================================
üìÖ Data/Hora: ${new Date().toLocaleString('pt-BR')}
üìä RESUMO:
‚Ä¢ Total registros originais: ${resultadoProcessamento.stats.totalOriginais}
‚Ä¢ Com data v√°lida: ${resultadoProcessamento.stats.comDataValida}
‚Ä¢ Check-ins encontrados: ${resultadoProcessamento.stats.checkin}
‚Ä¢ Confer√™ncias encontradas: ${resultadoProcessamento.stats.conferencia}
‚Ä¢ P√≥s-vendas encontradas: ${resultadoProcessamento.stats.posvenda}
‚Ä¢ Total processados: ${resultadoProcessamento.embarques.length}
‚Ä¢ Taxa de aproveitamento: ${((resultadoProcessamento.embarques.length / resultadoProcessamento.stats.totalOriginais) * 100).toFixed(1)}%

üìã DETALHES DOS IGNORADOS (${resultadoProcessamento.stats.ignorados} total):`;
                    
                    Object.entries(resultadoProcessamento.stats.detalhesIgnorados).forEach(([motivo, count]) => {
                        debugText += `\n‚Ä¢ ${motivo}: ${count}`;
                    });
                    
                    debugText += `\n\nüéØ PRIMEIROS 10 CHECK-INS ENCONTRADOS:`;
                    const checkins = resultadoProcessamento.embarques.filter(e => e.tipoControle === 'checkin').slice(0, 10);
                    checkins.forEach((embarque, i) => {
                        debugText += `\n${i+1}. ${embarque.nomeCliente} | ${embarque.dataIda.toLocaleDateString('pt-BR')} | ${embarque.diasParaIda} dias`;
                    });
                    
                    debugText += `\n\nüéØ PRIMEIRAS 10 CONFER√äNCIAS ENCONTRADAS:`;
                    const conferencias = resultadoProcessamento.embarques.filter(e => e.tipoControle === 'conferencia').slice(0, 10);
                    conferencias.forEach((embarque, i) => {
                        debugText += `\n${i+1}. ${embarque.nomeCliente} | ${embarque.dataIda.toLocaleDateString('pt-BR')} | ${embarque.diasParaIda} dias`;
                    });
                    
                    debugDiv.textContent = debugText;
                    
                } else {
                    throw new Error(result.message || 'Erro da API');
                }
                
            } catch (error) {
                console.error('‚ùå Erro no teste:', error);
                debugDiv.textContent = `‚ùå ERRO NO TESTE: ${error.message}`;
            }
        }
        
        // Auto-executar teste ao carregar
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(testarProcessamento, 1000);
        });
    </script>
</body>
</html>
