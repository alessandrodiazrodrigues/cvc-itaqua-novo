<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>üîç Diagn√≥stico de Datas - Embarques</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .btn { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 6px; margin: 8px; cursor: pointer; font-size: 14px; }
        .btn:hover { background: #0056b3; transform: translateY(-1px); }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-warning { background: #ffc107; color: #212529; }
        .result { background: #f8f9fa; border-left: 4px solid #007bff; padding: 15px; margin: 15px 0; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .info { background: #d1ecf1; border-left-color: #17a2b8; }
        .date-analysis { background: #fff3cd; border: 2px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .sample-box { background: #e9ecef; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de Datas - Sistema Embarques</h1>
        <p>Ferramenta para analisar especificamente os formatos de data da planilha</p>
        
        <div class="sample-box">
            <h3>üéØ OBJETIVO:</h3>
            <p>Descobrir o formato exato das datas que v√™m da planilha para corrigir o dashboard</p>
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button class="btn btn-success" onclick="analisarDatas()">üìÖ Analisar Datas</button>
            <button class="btn btn-warning" onclick="testarFormatos()">üîß Testar Formatos</button>
            <button class="btn btn-danger" onclick="limpar()">üßπ Limpar</button>
        </div>
        
        <div id="resultado" class="result" style="display: none;">
            Aguardando an√°lise...
        </div>
        
        <div class="date-analysis">
            <h4>üìã Formatos de Data Esperados:</h4>
            <ul>
                <li><strong>DD/MM/YYYY:</strong> 03/09/2025 (brasileiro)</li>
                <li><strong>DD/MM/YY:</strong> 03/09/25 (brasileiro curto)</li>
                <li><strong>YYYY-MM-DD:</strong> 2025-09-03 (ISO)</li>
                <li><strong>MM/DD/YYYY:</strong> 09/03/2025 (americano)</li>
            </ul>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxwckeJGdXdbtidZ3GV7DD3nkgbI8j33Kgh3p8-AIcu9VEjGsWXE4EZhHbEKBM6IuSEoQ/exec';
        
        function log(mensagem) {
            const resultado = document.getElementById('resultado');
            resultado.style.display = 'block';
            resultado.textContent += mensagem + '\n';
            resultado.scrollTop = resultado.scrollHeight;
        }
        
        async function analisarDatas() {
            log('üîç INICIANDO AN√ÅLISE DE DATAS');
            log('=====================================');
            
            try {
                log('üì° Carregando dados da API...');
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'text/plain;charset=utf-8',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ action: 'listar_embarques' })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const dados = result.data.embarques || [];
                    log(`‚úÖ ${dados.length} registros carregados\n`);
                    
                    // AN√ÅLISE ESPEC√çFICA DE DATAS
                    analisarCamposDatas(dados);
                    
                } else {
                    throw new Error(result.message || 'Erro da API');
                }
                
            } catch (error) {
                log(`‚ùå ERRO: ${error.message}`);
            }
        }
        
        function analisarCamposDatas(dados) {
            log('üìÖ AN√ÅLISE DETALHADA DE CAMPOS DE DATA');
            log('=====================================\n');
            
            const camposDatas = ['dataIda', 'dataCadastro', 'timestamp', 'dataVolta'];
            
            camposDatas.forEach(campo => {
                log(`üîç CAMPO: ${campo}`);
                log('-'.repeat(30));
                
                let exemplos = [];
                let tipos = new Set();
                let formatos = new Set();
                let validos = 0;
                let total = 0;
                
                dados.forEach((registro, index) => {
                    const valor = registro[campo];
                    if (valor !== null && valor !== undefined && valor !== '') {
                        total++;
                        tipos.add(typeof valor);
                        
                        // Coletar exemplos (m√°ximo 10)
                        if (exemplos.length < 10) {
                            exemplos.push(valor);
                        }
                        
                        // Detectar formato
                        if (typeof valor === 'string') {
                            if (valor.includes('T') && valor.includes('Z')) {
                                formatos.add('ISO DateTime (YYYY-MM-DDTHH:mm:ss.sssZ)');
                            } else if (valor.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                                formatos.add('DD/MM/YYYY');
                            } else if (valor.match(/^\d{2}\/\d{2}\/\d{2}$/)) {
                                formatos.add('DD/MM/YY');
                            } else if (valor.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                formatos.add('YYYY-MM-DD');
                            } else {
                                formatos.add('Outro formato');
                            }
                            
                            // Testar se pode ser convertido em data
                            try {
                                const data = new Date(valor);
                                if (!isNaN(data.getTime())) {
                                    validos++;
                                }
                            } catch (e) {
                                // Ignorar erros
                            }
                        }
                    }
                });
                
                const percentual = dados.length > 0 ? ((total / dados.length) * 100).toFixed(1) : 0;
                const percentualValidos = total > 0 ? ((validos / total) * 100).toFixed(1) : 0;
                
                log(`Registros preenchidos: ${total}/${dados.length} (${percentual}%)`);
                log(`Datas v√°lidas: ${validos}/${total} (${percentualValidos}%)`);
                log(`Tipos encontrados: ${Array.from(tipos).join(', ')}`);
                log(`Formatos detectados: ${Array.from(formatos).join(', ')}`);
                log(`Exemplos:`);
                exemplos.forEach((exemplo, i) => {
                    log(`  ${i+1}. "${exemplo}" (${typeof exemplo})`);
                });
                log('');
            });
        }
        
        function testarFormatos() {
            log('üîß TESTE DE CONVERS√ÉO DE FORMATOS');
            log('==================================\n');
            
            const exemplos = [
                '03/09/2025',
                '03/09/25',  
                '2025-09-03',
                '2025-09-03T10:00:00.000Z',
                '09/03/2025',
                '20250903',
                'true',
                'false',
                'ANTIGO'
            ];
            
            exemplos.forEach(exemplo => {
                log(`Testando: "${exemplo}"`);
                
                try {
                    // M√©todo 1: Parse direto
                    let data1 = new Date(exemplo);
                    let valida1 = !isNaN(data1.getTime());
                    log(`  Direct parse: ${valida1 ? '‚úÖ ' + data1.toLocaleDateString('pt-BR') : '‚ùå Inv√°lido'}`);
                    
                    // M√©todo 2: Se √© DD/MM/YYYY
                    if (exemplo.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                        const [dia, mes, ano] = exemplo.split('/');
                        const data2 = new Date(`${ano}-${mes}-${dia}`);
                        log(`  DD/MM/YYYY: ${!isNaN(data2.getTime()) ? '‚úÖ ' + data2.toLocaleDateString('pt-BR') : '‚ùå Inv√°lido'}`);
                    }
                    
                    // M√©todo 3: Se √© DD/MM/YY
                    if (exemplo.match(/^\d{2}\/\d{2}\/\d{2}$/)) {
                        const [dia, mes, anoShort] = exemplo.split('/');
                        const ano = parseInt(anoShort) > 50 ? '19' + anoShort : '20' + anoShort;
                        const data3 = new Date(`${ano}-${mes}-${dia}`);
                        log(`  DD/MM/YY: ${!isNaN(data3.getTime()) ? '‚úÖ ' + data3.toLocaleDateString('pt-BR') : '‚ùå Inv√°lido'}`);
                    }
                    
                } catch (error) {
                    log(`  ‚ùå Erro: ${error.message}`);
                }
                
                log('');
            });
        }
        
        function limpar() {
            document.getElementById('resultado').textContent = '';
            document.getElementById('resultado').style.display = 'none';
        }
    </script>
</body>
</html>
