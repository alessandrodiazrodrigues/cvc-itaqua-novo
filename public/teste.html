<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>üî¨ An√°lise Profunda dos Dados</title>
    <style>
        body { font-family: 'Courier New', monospace; margin: 20px; background: #1a1a1a; color: #00ff00; }
        .container { max-width: 1200px; margin: 0 auto; background: #000; padding: 20px; border-radius: 10px; border: 2px solid #00ff00; }
        h1 { text-align: center; color: #00ff00; text-shadow: 0 0 10px #00ff00; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; background: #111; }
        .btn { background: #006600; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 5px; cursor: pointer; }
        .btn:hover { background: #008800; }
        .output { background: #000; color: #00ff00; padding: 15px; border: 1px solid #00ff00; font-size: 12px; line-height: 1.4; max-height: 500px; overflow-y: auto; white-space: pre-wrap; }
        .error { color: #ff4444; }
        .warning { color: #ffaa44; }
        .success { color: #44ff44; }
        .info { color: #4488ff; }
        .critical { background: #330000; border: 2px solid #ff0000; color: #ff4444; padding: 10px; margin: 10px 0; }
        .table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        .table th, .table td { border: 1px solid #333; padding: 8px; text-align: left; }
        .table th { background: #222; color: #00ff00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ AN√ÅLISE PROFUNDA DOS DADOS - DIAGN√ìSTICO COMPLETO</h1>
        
        <div class="critical">
            <h3>‚ö†Ô∏è PROBLEMA IDENTIFICADO:</h3>
            <p>Dashboard processando apenas 1/1594 registros (0.06%). Necess√°ria an√°lise profunda para identificar causas.</p>
        </div>
        
        <div class="section">
            <h3>üéØ AN√ÅLISES DISPON√çVEIS:</h3>
            <button class="btn" onclick="analiseCompleta()">üìä An√°lise Estrutural Completa</button>
            <button class="btn" onclick="analiseCamposVazios()">üï≥Ô∏è An√°lise Campos Vazios</button>
            <button class="btn" onclick="analiseValidacao()">‚úÖ Teste Valida√ß√£o Atual</button>
            <button class="btn" onclick="analiseAmostras()">üîç An√°lise Amostras Detalhada</button>
            <button class="btn" onclick="proposta()">üí° Gerar Proposta de Solu√ß√£o</button>
            <button class="btn" onclick="limpar()">üßπ Limpar</button>
        </div>
        
        <div class="section">
            <h3>üìã RESULTADO DA AN√ÅLISE:</h3>
            <div id="output" class="output">
Aguardando in√≠cio da an√°lise...

Execute as an√°lises na ordem para diagn√≥stico completo:
1. üìä An√°lise Estrutural Completa
2. üï≥Ô∏è An√°lise Campos Vazios  
3. ‚úÖ Teste Valida√ß√£o Atual
4. üîç An√°lise Amostras Detalhada
5. üí° Gerar Proposta de Solu√ß√£o
            </div>
        </div>
        
        <div class="section">
            <h3>üìà ESTAT√çSTICAS EM TEMPO REAL:</h3>
            <table class="table">
                <tr>
                    <th>M√©trica</th>
                    <th>Valor</th>
                    <th>Status</th>
                </tr>
                <tr>
                    <td>Registros Carregados</td>
                    <td id="stat-total">-</td>
                    <td id="stat-total-status">Aguardando</td>
                </tr>
                <tr>
                    <td>Registros V√°lidos</td>
                    <td id="stat-validos">-</td>
                    <td id="stat-validos-status">Aguardando</td>
                </tr>
                <tr>
                    <td>Taxa de Aproveitamento</td>
                    <td id="stat-taxa">-</td>
                    <td id="stat-taxa-status">Aguardando</td>
                </tr>
                <tr>
                    <td>Campos com Dados</td>
                    <td id="stat-campos">-</td>
                    <td id="stat-campos-status">Aguardando</td>
                </tr>
            </table>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxwckeJGdXdbtidZ3GV7DD3nkgbI8j33Kgh3p8-AIcu9VEjGsWXE4EZhHbEKBM6IuSEoQ/exec';
        
        let dadosOriginais = [];
        let analiseResultados = {};
        
        function log(mensagem, tipo = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const prefixo = {
                'error': '[ERROR]',
                'warning': '[WARN]',
                'success': '[OK]',
                'info': '[INFO]'
            }[tipo];
            
            output.innerHTML += `<span class="${tipo}">[${timestamp}] ${prefixo} ${mensagem}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function updateStat(metrica, valor, status) {
            document.getElementById(`stat-${metrica}`).textContent = valor;
            document.getElementById(`stat-${metrica}-status`).textContent = status;
        }
        
        async function carregarDados() {
            if (dadosOriginais.length > 0) {
                log('Usando dados j√° carregados em cache', 'info');
                return dadosOriginais;
            }
            
            try {
                log('Carregando dados da API...', 'info');
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'text/plain;charset=utf-8',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ action: 'listar_embarques' })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    dadosOriginais = result.data.embarques || [];
                    log(`${dadosOriginais.length} registros carregados com sucesso`, 'success');
                    updateStat('total', dadosOriginais.length, 'Carregado');
                    return dadosOriginais;
                } else {
                    throw new Error(result.message || 'Erro da API');
                }
                
            } catch (error) {
                log(`Erro ao carregar dados: ${error.message}`, 'error');
                updateStat('total', '0', 'Erro');
                throw error;
            }
        }
        
        async function analiseCompleta() {
            log('='.repeat(60), 'info');
            log('INICIANDO AN√ÅLISE ESTRUTURAL COMPLETA', 'info');
            log('='.repeat(60), 'info');
            
            try {
                const dados = await carregarDados();
                
                log(`Analisando estrutura de ${dados.length} registros...`, 'info');
                
                // Mapear todos os campos √∫nicos
                const todosCampos = new Set();
                const tipoPorCampo = {};
                const exemploPorCampo = {};
                const contadorPorCampo = {};
                
                dados.forEach((registro, index) => {
                    Object.keys(registro).forEach(campo => {
                        todosCampos.add(campo);
                        
                        if (!tipoPorCampo[campo]) {
                            tipoPorCampo[campo] = new Set();
                            exemploPorCampo[campo] = [];
                            contadorPorCampo[campo] = 0;
                        }
                        
                        const valor = registro[campo];
                        if (valor !== null && valor !== undefined && valor !== '') {
                            contadorPorCampo[campo]++;
                            tipoPorCampo[campo].add(typeof valor);
                            
                            if (exemploPorCampo[campo].length < 5) {
                                exemploPorCampo[campo].push(valor);
                            }
                        }
                    });
                });
                
                log(`\nCampos encontrados: ${todosCampos.size}`, 'success');
                updateStat('campos', todosCampos.size, 'Mapeado');
                
                log('\nDETALHES POR CAMPO:', 'info');
                log('-'.repeat(50), 'info');
                
                Array.from(todosCampos).sort().forEach((campo, index) => {
                    const preenchidos = contadorPorCampo[campo] || 0;
                    const percentual = ((preenchidos / dados.length) * 100).toFixed(1);
                    const tipos = tipoPorCampo[campo] ? Array.from(tipoPorCampo[campo]).join(', ') : 'vazio';
                    const exemplos = exemploPorCampo[campo] ? exemploPorCampo[campo].slice(0, 3).join(' | ') : 'N/A';
                    
                    const qualidade = percentual > 50 ? 'ALTA' : percentual > 10 ? 'M√âDIA' : 'BAIXA';
                    
                    log(`${(index + 1).toString().padStart(2, '0')}. ${campo}`, 'info');
                    log(`    Preenchimento: ${preenchidos}/${dados.length} (${percentual}%) - ${qualidade}`, 
                        qualidade === 'ALTA' ? 'success' : qualidade === 'M√âDIA' ? 'warning' : 'error');
                    log(`    Tipos: ${tipos}`, 'info');
                    log(`    Exemplos: ${exemplos}`, 'info');
                    log('', 'info');
                });
                
                analiseResultados.estrutural = { todosCampos, tipoPorCampo, exemploPorCampo, contadorPorCampo };
                
            } catch (error) {
                log(`Erro na an√°lise: ${error.message}`, 'error');
            }
        }
        
        async function analiseCamposVazios() {
            log('='.repeat(60), 'info');
            log('AN√ÅLISE DE CAMPOS VAZIOS / PROBLEM√ÅTICOS', 'info');
            log('='.repeat(60), 'info');
            
            try {
                const dados = await carregarDados();
                
                if (!analiseResultados.estrutural) {
                    log('Execute primeiro a An√°lise Estrutural Completa', 'warning');
                    return;
                }
                
                const { contadorPorCampo } = analiseResultados.estrutural;
                
                // Separar campos por qualidade
                const camposAlta = [];
                const camposMedia = [];
                const camposBaixa = [];
                const camposVazios = [];
                
                Object.keys(contadorPorCampo).forEach(campo => {
                    const preenchidos = contadorPorCampo[campo];
                    const percentual = (preenchidos / dados.length) * 100;
                    
                    if (preenchidos === 0) {
                        camposVazios.push(campo);
                    } else if (percentual > 50) {
                        camposAlta.push({ campo, preenchidos, percentual });
                    } else if (percentual > 10) {
                        camposMedia.push({ campo, preenchidos, percentual });
                    } else {
                        camposBaixa.push({ campo, preenchidos, percentual });
                    }
                });
                
                log('CAMPOS DE ALTA QUALIDADE (>50%):', 'success');
                camposAlta.forEach(item => {
                    log(`  ‚úÖ ${item.campo}: ${item.preenchidos} registros (${item.percentual.toFixed(1)}%)`, 'success');
                });
                
                log('\nCAMPOS DE M√âDIA QUALIDADE (10-50%):', 'warning');
                camposMedia.forEach(item => {
                    log(`  ‚ö†Ô∏è ${item.campo}: ${item.preenchidos} registros (${item.percentual.toFixed(1)}%)`, 'warning');
                });
                
                log('\nCAMPOS DE BAIXA QUALIDADE (<10%):', 'error');
                camposBaixa.forEach(item => {
                    log(`  ‚ùå ${item.campo}: ${item.preenchidos} registros (${item.percentual.toFixed(1)}%)`, 'error');
                });
                
                log('\nCAMPOS COMPLETAMENTE VAZIOS:', 'error');
                camposVazios.forEach(campo => {
                    log(`  üíÄ ${campo}: 0 registros`, 'error');
                });
                
                analiseResultados.qualidade = { camposAlta, camposMedia, camposBaixa, camposVazios };
                
            } catch (error) {
                log(`Erro na an√°lise: ${error.message}`, 'error');
            }
        }
        
        async function analiseValidacao() {
            log('='.repeat(60), 'info');
            log('TESTE DA VALIDA√á√ÉO ATUAL DO DASHBOARD', 'info');
            log('='.repeat(60), 'info');
            
            try {
                const dados = await carregarDados();
                
                log('Aplicando mesma valida√ß√£o do dashboard...', 'info');
                
                let aprovados = 0;
                let rejeitados = 0;
                let motivosRejeicao = {};
                
                dados.forEach((registro, index) => {
                    const nomeCliente = registro.nomeCliente || '';
                    const cpfCliente = registro.cpfCliente || '';
                    const vendedor = registro.vendedor || '';
                    
                    let rejeitado = false;
                    let motivo = '';
                    
                    // Simular valida√ß√£o do dashboard
                    if (!registro || typeof registro !== 'object') {
                        rejeitado = true;
                        motivo = 'Estrutura inv√°lida';
                    } else if (!nomeCliente || typeof nomeCliente !== 'string' || nomeCliente.length < 2) {
                        rejeitado = true;
                        motivo = 'Nome inv√°lido';
                    } else if (!cpfCliente || typeof cpfCliente !== 'string' || cpfCliente.length < 3) {
                        rejeitado = true;
                        motivo = 'CPF inv√°lido';
                    } else if (!vendedor || typeof vendedor !== 'string' || vendedor.length < 2) {
                        rejeitado = true;
                        motivo = 'Vendedor inv√°lido';
                    } else {
                        const nomeUpper = nomeCliente.toUpperCase();
                        if (nomeUpper === '6220' || nomeUpper === 'TESTE' || nomeUpper === 'SISTEMA' || nomeUpper === 'AAAAAAAAA') {
                            rejeitado = true;
                            motivo = 'Nome √© c√≥digo de teste';
                        }
                    }
                    
                    if (rejeitado) {
                        rejeitados++;
                        motivosRejeicao[motivo] = (motivosRejeicao[motivo] || 0) + 1;
                    } else {
                        aprovados++;
                        
                        // Log dos primeiros 10 aprovados
                        if (aprovados <= 10) {
                            log(`‚úÖ APROVADO ${aprovados}: "${nomeCliente}" | CPF: "${cpfCliente}" | Vendedor: "${vendedor}"`, 'success');
                        }
                    }
                });
                
                const taxa = ((aprovados / dados.length) * 100).toFixed(2);
                
                log(`\nRESULTADO DA VALIDA√á√ÉO:`, 'info');
                log(`Aprovados: ${aprovados}/${dados.length} (${taxa}%)`, aprovados > 0 ? 'success' : 'error');
                log(`Rejeitados: ${rejeitados}/${dados.length}`, 'warning');
                
                log(`\nMOTIVOS DE REJEI√á√ÉO:`, 'warning');
                Object.keys(motivosRejeicao).forEach(motivo => {
                    log(`  ${motivo}: ${motivosRejeicao[motivo]} casos`, 'warning');
                });
                
                updateStat('validos', aprovados, aprovados > 100 ? 'Bom' : aprovados > 10 ? 'Baixo' : 'Cr√≠tico');
                updateStat('taxa', `${taxa}%`, taxa > 10 ? 'Aceit√°vel' : 'Problem√°tico');
                
                analiseResultados.validacao = { aprovados, rejeitados, motivosRejeicao, taxa };
                
            } catch (error) {
                log(`Erro na valida√ß√£o: ${error.message}`, 'error');
            }
        }
        
        async function analiseAmostras() {
            log('='.repeat(60), 'info');
            log('AN√ÅLISE DETALHADA DE AMOSTRAS', 'info');
            log('='.repeat(60), 'info');
            
            try {
                const dados = await carregarDados();
                
                log('Analisando primeiros 20 registros em detalhes:', 'info');
                
                dados.slice(0, 20).forEach((registro, index) => {
                    log(`\n--- REGISTRO ${index + 1} (ID: ${registro.id || 'N/A'}) ---`, 'info');
                    
                    Object.keys(registro).sort().forEach(campo => {
                        const valor = registro[campo];
                        const tipo = typeof valor;
                        const valorStr = valor === null ? 'null' : 
                                       valor === undefined ? 'undefined' :
                                       valor === '' ? 'string vazia' :
                                       String(valor).length > 50 ? String(valor).substring(0, 50) + '...' : 
                                       String(valor);
                        
                        log(`  ${campo}: "${valorStr}" (${tipo})`, 'info');
                    });
                });
                
            } catch (error) {
                log(`Erro na an√°lise de amostras: ${error.message}`, 'error');
            }
        }
        
        function proposta() {
            log('='.repeat(60), 'info');
            log('PROPOSTA DE SOLU√á√ÉO BASEADA NA AN√ÅLISE', 'info');
            log('='.repeat(60), 'info');
            
            if (!analiseResultados.validacao) {
                log('Execute todas as an√°lises anteriores primeiro', 'warning');
                return;
            }
            
            const { aprovados, motivosRejeicao } = analiseResultados.validacao;
            
            log('DIAGN√ìSTICO:', 'info');
            if (aprovados < 10) {
                log('‚ùå PROBLEMA CR√çTICO: Menos de 10 registros aprovados', 'error');
                log('   Causa prov√°vel: Valida√ß√£o excessivamente restritiva', 'error');
            } else if (aprovados < 100) {
                log('‚ö†Ô∏è PROBLEMA MODERADO: Poucos registros aprovados', 'warning');
                log('   Causa prov√°vel: Dados de baixa qualidade', 'warning');
            } else {
                log('‚úÖ VALIDA√á√ÉO OK: Registros suficientes aprovados', 'success');
            }
            
            log('\nSOLU√á√ïES RECOMENDADAS:', 'info');
            log('1. AJUSTAR VALIDA√á√ÉO:', 'success');
            log('   - Reduzir crit√©rios m√≠nimos (CPF: 3‚Üí1 char, Nome: 2‚Üí1 char)', 'info');
            log('   - Remover filtros de c√≥digos de teste desnecess√°rios', 'info');
            log('   - Aceitar mais varia√ß√µes de dados', 'info');
            
            log('\n2. TRATAMENTO DE DATAS:', 'success');
            log('   - Implementar fallback robusto para 98% dos registros sem data', 'info');
            log('   - Usar algoritmo de distribui√ß√£o temporal inteligente', 'info');
            log('   - Considerar data de cadastro como base quando dispon√≠vel', 'info');
            
            log('\n3. C√ìDIGO DE IMPLEMENTA√á√ÉO:', 'success');
            log('```javascript', 'info');
            log('function validacaoUltraPermissiva(registro) {', 'info');
            log('    // Aceitar qualquer coisa minimamente estruturada', 'info');
            log('    return registro &&', 'info');
            log('           registro.nomeCliente && registro.nomeCliente.length > 0 &&', 'info');
            log('           registro.cpfCliente && registro.cpfCliente.length > 0 &&', 'info');
            log('           registro.vendedor && registro.vendedor.length > 0;', 'info');
            log('}', 'info');
            log('```', 'info');
            
            log('\n4. RESULTADOS ESPERADOS:', 'success');
            log(`   - Taxa de aproveitamento: 70-90% (atual: ${analiseResultados.validacao.taxa}%)`, 'info');
            log('   - Embarques distribu√≠dos entre as 3 categorias', 'info');
            log('   - Sistema funcional para demonstra√ß√£o', 'info');
        }
        
        function limpar() {
            document.getElementById('output').innerHTML = 'Log limpo. Execute as an√°lises novamente.\n';
            updateStat('total', '-', 'Aguardando');
            updateStat('validos', '-', 'Aguardando');
            updateStat('taxa', '-', 'Aguardando');
            updateStat('campos', '-', 'Aguardando');
        }
    </script>
</body>
</html>
