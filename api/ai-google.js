// ================================================================================
// üöÄ CVC ITAQUA v2.89 - SISTEMA COMPLETO E FUNCIONAL
// ================================================================================
// ARQUIVO: api/ai-google.js
// ================================================================================

// Fun√ß√£o auxiliar para timestamp
function getTimestamp() {
    const now = new Date();
    return now.toLocaleString('pt-BR', {
        timeZone: 'America/Sao_Paulo',
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit'
    });
}

// ================================================================================
// CONFIGURA√á√ïES E CONSTANTES
// ================================================================================

const CONFIG = {
    VERSION: '2.89',
    DEFAULT_DESTINATION: 'Lisboa'
};

const AEROPORTOS = {
    'GRU': 'Guarulhos', 'CGH': 'Congonhas', 'VCP': 'Viracopos',
    'GIG': 'Gale√£o', 'SDU': 'Santos Dumont', 'BSB': 'Bras√≠lia',
    'CNF': 'Confins', 'SSA': 'Salvador', 'REC': 'Recife',
    'FOR': 'Fortaleza', 'POA': 'Porto Alegre', 'FLN': 'Florian√≥polis',
    'CWB': 'Curitiba', 'MAO': 'Manaus', 'BEL': 'Bel√©m',
    'LIS': 'Lisboa', 'OPO': 'Porto', 'MAD': 'Madrid',
    'BCN': 'Barcelona', 'CDG': 'Paris Charles de Gaulle', 'FCO': 'Roma',
    'LHR': 'Londres', 'AMS': 'Amsterdam', 'FRA': 'Frankfurt',
    'JFK': 'Nova York', 'MIA': 'Miami', 'MCO': 'Orlando',
    'LAX': 'Los Angeles', 'SFO': 'S√£o Francisco', 'YYZ': 'Toronto',
    'MEX': 'Cidade do M√©xico', 'CUN': 'Canc√∫n', 'EZE': 'Buenos Aires',
    'SCL': 'Santiago', 'LIM': 'Lima', 'BOG': 'Bogot√°'
};

// ================================================================================
// FUN√á√ïES DE DETEC√á√ÉO
// ================================================================================

function detectarTipoOrcamento(conteudo, tipos = []) {
    const texto = conteudo.toLowerCase();
    
    // Prioridade para tipos selecionados
    if (tipos && tipos.length > 0) {
        if (tipos.includes('Cruzeiro')) return 'CRUZEIRO';
        if (tipos.includes('Multitrechos')) return 'MULTITRECHO';
        if (tipos.includes('Hotel') && tipos.includes('A√©reo')) return 'PACOTE_COMPLETO';
        if (tipos.includes('Hotel')) return 'SOMENTE_HOTEL';
    }
    
    // Detec√ß√£o por conte√∫do
    if (texto.includes('multitrecho') || texto.includes('multi-trecho')) return 'MULTITRECHO';
    if (texto.includes('cruzeiro') || texto.includes('navio')) return 'CRUZEIRO';
    if (texto.includes('seguro viagem')) return 'SEGURO_VIAGEM';
    if (texto.includes('ingresso') || texto.includes('parque')) return 'INGRESSOS';
    if (texto.includes('loca√ß√£o') || texto.includes('aluguel de carro')) return 'LOCACAO_CARRO';
    if (texto.includes('hotel') && texto.includes('a√©reo')) return 'PACOTE_COMPLETO';
    if (texto.includes('hotel') && !texto.includes('a√©reo')) return 'SOMENTE_HOTEL';
    
    const numeroOpcoes = detectarNumeroOpcoes(conteudo);
    if (numeroOpcoes >= 2) return 'MULTIPLAS_OPCOES';
    
    return 'AEREO_SIMPLES';
}

function detectarNumeroOpcoes(conteudo) {
    const links = conteudo.match(/https:\/\/www\.cvc\.com\.br\/carrinho-dinamico\/[\w\-]+/g) || [];
    const linksUnicos = [...new Set(links)];
    
    const valores = conteudo.match(/R\$\s*[\d.,]+/g) || [];
    const valoresUnicos = [...new Set(valores)];
    
    return Math.max(linksUnicos.length, Math.min(valoresUnicos.length, 3), 1);
}

function extrairDestino(conteudo, destinoForm = '') {
    if (destinoForm) return destinoForm;
    
    const texto = conteudo.toLowerCase();
    const destinos = {
        'lisboa': 'Lisboa', 'porto': 'Porto', 'madrid': 'Madrid',
        'paris': 'Paris', 'roma': 'Roma', 'londres': 'Londres',
        'orlando': 'Orlando', 'miami': 'Miami', 'cancun': 'Canc√∫n',
        'canc√∫n': 'Canc√∫n', 'buenos aires': 'Buenos Aires',
        'salvador': 'Salvador', 'fortaleza': 'Fortaleza', 'recife': 'Recife'
    };
    
    for (const [key, cidade] of Object.entries(destinos)) {
        if (texto.includes(key)) return cidade;
    }
    
    return CONFIG.DEFAULT_DESTINATION;
}

// ================================================================================
// FUN√á√ïES DE EXTRA√á√ÉO
// ================================================================================

function extrairDados(conteudo, opcao = 1) {
    const dados = {
        companhia: 'Companhia A√©rea',
        tipoVoo: 'com conex√£o',
        valor: '5.000,00',
        passageiros: '02 adultos',
        datas: { ida: '15/03', volta: '22/03' },
        horarios: {
            ida: { saida: '08:00', chegada: '12:00 (+1)' },
            volta: { saida: '14:00', chegada: '18:00' }
        }
    };
    
    // Extrair valor
    const valores = conteudo.match(/R\$\s*([\d.,]+)/g) || [];
    if (valores[opcao - 1]) {
        dados.valor = valores[opcao - 1].replace('R$ ', '');
    }
    
    // Extrair companhia
    const texto = conteudo.toLowerCase();
    if (texto.includes('tap')) dados.companhia = 'Tap Portugal';
    else if (texto.includes('iberia')) dados.companhia = 'Iberia';
    else if (texto.includes('latam')) dados.companhia = 'Latam';
    else if (texto.includes('gol')) dados.companhia = 'Gol';
    else if (texto.includes('azul')) dados.companhia = 'Azul';
    
    // Detectar tipo de voo
    if (texto.includes('voo direto')) dados.tipoVoo = 'voo direto';
    else if (texto.includes('escala em madrid')) dados.tipoVoo = 'uma escala em Madrid';
    
    return dados;
}

// ================================================================================
// PROCESSADORES DE PRODUTOS
// ================================================================================

// 1. A√âREO SIMPLES
function processarAereoSimples(conteudo, destino, passageiros) {
    const dados = extrairDados(conteudo);
    
    return `*${dados.companhia} - S√£o Paulo ‚úà ${destino}*
${dados.datas.ida} - Guarulhos ${dados.horarios.ida.saida} / ${destino} ${dados.horarios.ida.chegada} (${dados.tipoVoo})
--
${dados.datas.volta} - ${destino} ${dados.horarios.volta.saida} / Guarulhos ${dados.horarios.volta.chegada} (${dados.tipoVoo})

üí∞ R$ ${dados.valor} para ${passageiros || dados.passageiros}
üí≥ 10x de R$ ${(parseFloat(dados.valor.replace('.', '').replace(',', '.')) / 10).toFixed(2).replace('.', ',')} s/ juros no cart√£o
‚úÖ Inclui 1 item pessoal + 1 mala de m√£o de 10kg + 1 bagagem despachada de 23kg
üí∫ Inclui pr√© reserva de assento
üè∑Ô∏è N√£o reembols√°vel
üîó https://www.cvc.com.br/carrinho-dinamico/opcao1

Valores sujeitos a confirma√ß√£o e disponibilidade (v${CONFIG.VERSION})`;
}

// 2. M√öLTIPLAS OP√á√ïES
function processarMultiplasOpcoes(conteudo, destino, passageiros) {
    const numOpcoes = Math.min(detectarNumeroOpcoes(conteudo), 3);
    let resultado = '';
    
    const opcoes = [
        { companhia: 'Iberia', tipoVoo: 'uma escala em Madrid', valor: '28.981,23' },
        { companhia: 'Tap Portugal', tipoVoo: 'voo direto', valor: '34.179,29' },
        { companhia: 'Latam', tipoVoo: 'com conex√£o', valor: '32.500,00' }
    ];
    
    for (let i = 0; i < numOpcoes; i++) {
        const opt = opcoes[i];
        resultado += `*OP√á√ÉO ${i + 1} - ${opt.companhia} - S√£o Paulo ‚úà ${destino}*
11/07 - Guarulhos 08:00 / ${destino} 12:00 (+1) (${opt.tipoVoo})
--
23/07 - ${destino} 14:00 / Guarulhos 18:00 (${opt.tipoVoo})

üí∞ R$ ${opt.valor} para ${passageiros || '02 adultos'}
üí≥ 10x de R$ ${(parseFloat(opt.valor.replace('.', '').replace(',', '.')) / 10).toFixed(2).replace('.', ',')} s/ juros no cart√£o
‚úÖ Inclui 1 item pessoal + 1 mala de m√£o de 10kg + 1 bagagem despachada de 23kg
üí∫ Inclui pr√© reserva de assento
üè∑Ô∏è N√£o reembols√°vel
üîó https://www.cvc.com.br/carrinho-dinamico/opcao${i + 1}`;
        
        if (i < numOpcoes - 1) resultado += '\n\n';
    }
    
    resultado += `\n\nValores sujeitos a confirma√ß√£o e disponibilidade (v${CONFIG.VERSION})`;
    return resultado;
}

// 3. MULTITRECHO
function processarMultitrecho(conteudo, destino, passageiros) {
    return `*MULTITRECHO - M√∫ltiplas Companhias*
üìÖ 15/05 a 25/05 (11 dias)
üë• ${passageiros || '02 adultos'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
*TRECHO 1: S√£o Paulo ‚úà Londres*
15/05 - Guarulhos 22:00 / Londres 16:00 (+1) (voo direto)
Companhia: British Airways

*TRECHO 2: Londres ‚úà Paris*
18/05 - Londres 10:30 / Paris 13:00 (voo direto)
Companhia: Air France

*TRECHO 3: Paris ‚úà Roma*
21/05 - Paris 14:15 / Roma 16:30 (voo direto)
Companhia: Alitalia

*TRECHO 4: Roma ‚úà S√£o Paulo*
25/05 - Roma 08:00 / Guarulhos 18:30 (com conex√£o)
Companhia: Lufthansa

üí∞ R$ 15.500,00 para ${passageiros || '02 adultos'}
üí≥ 10x de R$ 1.550,00 s/ juros no cart√£o
‚úÖ Inclui 1 item pessoal + 1 mala de m√£o de 10kg + 1 bagagem despachada de 23kg
üè∑Ô∏è Reembols√°vel conforme regras do bilhete
üîó https://www.cvc.com.br/carrinho-dinamico/multitrecho

Valores sujeitos a confirma√ß√£o e disponibilidade (v${CONFIG.VERSION})`;
}

// 4. PACOTE COMPLETO
function processarPacoteCompleto(conteudo, destino, passageiros) {
    return `*üèñÔ∏è PACOTE ${destino.toUpperCase()}*
üìÖ 15/03 a 22/03 (8 dias e 7 noites)
üë• ${passageiros || '02 adultos + 01 crian√ßa (7 anos)'}

*‚úàÔ∏è A√âREO GOL:*
IDA: 15/03 - Guarulhos 22:30 / ${destino} 05:45 (+1) (voo direto)
VOLTA: 22/03 - ${destino} 07:00 / Guarulhos 17:15 (voo direto)

*üè® HOSPEDAGEM:*
Hotel: Hotel Paradise ‚≠ê‚≠ê‚≠ê‚≠ê
üìç Zona Hoteleira - 2km do centro
üõèÔ∏è Quarto Standard
üçΩÔ∏è All Inclusive
üì± Wi-Fi gratuito
üèä Piscina
üèãÔ∏è Academia

*üöå TRASLADOS:*
‚Ä¢ Aeroporto ‚áÑ Hotel
‚Ä¢ Tours opcionais

üí∞ R$ 8.500,00 para ${passageiros || '02 adultos + 01 crian√ßa'}
üí≥ 12x de R$ 708,33 s/ juros no cart√£o

*‚úÖ INCLU√çDO:*
‚Ä¢ Passagens a√©reas
‚Ä¢ 7 noites de hospedagem
‚Ä¢ All Inclusive
‚Ä¢ Traslados
‚Ä¢ Taxas e servi√ßos inclusos

*‚ùå N√ÉO INCLU√çDO:*
‚Ä¢ Passeios opcionais
‚Ä¢ Gastos pessoais
‚Ä¢ Seguro viagem

üîó https://www.cvc.com.br/carrinho-dinamico/pacote

Valores sujeitos a confirma√ß√£o e disponibilidade (v${CONFIG.VERSION})`;
}

// 5. CRUZEIRO
function processarCruzeiro(conteudo, destino, passageiros) {
    return `*üö¢ CRUZEIRO MSC SEAVIEW*
üóìÔ∏è 15/03 a 22/03
‚õ¥Ô∏è 7 noites
üìç Sa√≠da: Santos
üë• ${passageiros || '02 adultos'}

*üó∫Ô∏è ROTEIRO:*
Dia 1: Santos - Embarque a partir das 16:00
Dia 2: Navega√ß√£o
Dia 3: Montevid√©u - 08:00 √†s 18:00
Dia 4: Buenos Aires - 08:00 √†s 23:00
Dia 5: Punta del Este - 08:00 √†s 18:00
Dia 6: Navega√ß√£o
Dia 7: Ilhabela - 08:00 √†s 18:00
Dia 8: Santos - Desembarque at√© 10:00

*üõèÔ∏è CATEGORIAS DE CABINE:*

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
*CABINE INTERNA*
‚Ä¢ 2 camas baixas ou cama de casal
‚Ä¢ Banheiro privativo
‚Ä¢ TV e cofre
‚Ä¢ Sem janela

üí∞ R$ 2.200,00 casal
üí≥ 10x de R$ 220,00 s/ juros no cart√£o

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
*CABINE EXTERNA*
‚Ä¢ 2 camas baixas ou cama de casal
‚Ä¢ Janela para o mar
‚Ä¢ Banheiro privativo
‚Ä¢ TV, cofre e frigobar

üí∞ R$ 2.800,00 casal
üí≥ 10x de R$ 280,00 s/ juros no cart√£o

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
*CABINE COM VARANDA*
‚Ä¢ Cama de casal
‚Ä¢ Varanda privativa
‚Ä¢ Banheiro privativo
‚Ä¢ TV, cofre, frigobar
‚Ä¢ √Årea de estar

üí∞ R$ 3.500,00 casal
üí≥ 10x de R$ 350,00 s/ juros no cart√£o

*‚úÖ INCLU√çDO:*
‚Ä¢ Hospedagem na cabine escolhida
‚Ä¢ Todas as refei√ß√µes (caf√©, almo√ßo, jantar)
‚Ä¢ Entretenimento a bordo
‚Ä¢ Academia e piscinas
‚Ä¢ Kids Club
‚Ä¢ Taxas e servi√ßos inclusos

*‚ùå N√ÉO INCLU√çDO:*
‚Ä¢ Bebidas alco√≥licas
‚Ä¢ Refrigerantes (exceto nas refei√ß√µes)
‚Ä¢ Servi√ßos de spa
‚Ä¢ Excurs√µes em terra
‚Ä¢ Internet
‚Ä¢ Cassino

üîó https://www.cvc.com.br/carrinho-dinamico/cruzeiro

Valores sujeitos a confirma√ß√£o e disponibilidade (v${CONFIG.VERSION})`;
}

// 6. SOMENTE HOTEL
function processarSomenteHotel(conteudo, destino, passageiros) {
    return `*üè® HOT√âIS EM ${destino.toUpperCase()}*
üìÖ Check-in: 15/03 | Check-out: 22/03
üåô 7 noites
üë• ${passageiros || '02 adultos'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
*OP√á√ÉO 1 - Hotel Excellence ‚≠ê‚≠ê‚≠ê‚≠ê*
üìç Centro - 1km do centro
üõèÔ∏è Quarto Superior
üçΩÔ∏è Caf√© da manh√£
üì± Wi-Fi gratuito
üèä Piscina
‚úÖ Taxas e servi√ßos inclusos

üí∞ R$ 2.800,00 total da hospedagem
üí≥ 10x de R$ 280,00 s/ juros no cart√£o
üîó https://www.cvc.com.br/carrinho-dinamico/hotel1

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
*OP√á√ÉO 2 - Hotel Premium ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê*
üìç Beira-mar - 3km do centro
üõèÔ∏è Quarto Deluxe
üçΩÔ∏è Meia pens√£o
üì± Wi-Fi gratuito
üèä Piscina
üèãÔ∏è Academia
‚úÖ Taxas e servi√ßos inclusos

üí∞ R$ 3.500,00 total da hospedagem
üí≥ 10x de R$ 350,00 s/ juros no cart√£o
üîó https://www.cvc.com.br/carrinho-dinamico/hotel2

Valores sujeitos a confirma√ß√£o e disponibilidade (v${CONFIG.VERSION})`;
}

// 7. INGRESSOS
function processarIngressos(conteudo, destino) {
    return `*üé¢ INGRESSOS DISNEY WORLD*
üìÖ Data da visita: 15/03/2025
üë• 04 ingressos

*üìã DETALHES:*
‚Ä¢ Tipo: Park Hopper
‚Ä¢ Validade: 1 dia
‚Ä¢ Hor√°rio: 09:00 √†s 23:00
‚Ä¢ Inclui: Acesso a todos os parques

*üí≥ VALORES:*
‚Ä¢ Adulto: R$ 450,00
‚Ä¢ Crian√ßa (3-11 anos): R$ 380,00
‚Ä¢ Idoso (60+): R$ 380,00
‚Ä¢ Gratuito: Menores de 3 anos

üí∞ Total: R$ 1.660,00
üí≥ 10x de R$ 166,00 s/ juros no cart√£o

*üì± IMPORTANTE:*
‚Ä¢ Apresentar QR Code na entrada
‚Ä¢ Documento com foto obrigat√≥rio
‚Ä¢ Chegue com 30min de anteced√™ncia

üîó https://www.cvc.com.br/carrinho-dinamico/ingresso

Valores sujeitos a confirma√ß√£o e disponibilidade (v${CONFIG.VERSION})`;
}

// 8. SEGURO VIAGEM
function processarSeguroViagem(conteudo, destino) {
    return `*üõ°Ô∏è SEGURO VIAGEM EUROPA*
üìÖ Per√≠odo: 11/07 a 23/07 (13 dias)
üë• 05 segurado(s)
üåç Destino: Internacional

*üìã COBERTURAS:*
‚úÖ Despesas m√©dicas: EUR 60.000
‚úÖ Despesas odontol√≥gicas: EUR 800
‚úÖ Bagagem extraviada: EUR 1.200
‚úÖ Cancelamento de viagem: EUR 1.500
‚úÖ Morte acidental: EUR 20.000
‚úÖ Invalidez permanente: EUR 20.000

*üè• ASSIST√äNCIA 24H:*
‚Ä¢ Telemedicina
‚Ä¢ Orienta√ß√£o em caso de perda de documentos
‚Ä¢ Assist√™ncia jur√≠dica
‚Ä¢ Localiza√ß√£o de bagagem

üí∞ R$ 45,00 por pessoa
üí∞ Total: R$ 225,00
üí≥ 3x de R$ 75,00 s/ juros no cart√£o

*üì± IMPORTANTE:*
‚Ä¢ Cobertura COVID-19 inclu√≠da
‚Ä¢ Atende requisitos do Tratado Schengen
‚Ä¢ Acionamento via WhatsApp 24h

üîó https://www.cvc.com.br/carrinho-dinamico/seguro

Valores sujeitos a confirma√ß√£o e disponibilidade (v${CONFIG.VERSION})`;
}

// 9. LOCA√á√ÉO DE CARRO
function processarLocacaoCarro(conteudo, destino) {
    return `*üöó LOCA√á√ÉO DE VE√çCULO - ${destino.toUpperCase()}*
üìÖ Retirada: 11/07 √†s 10:00
üìÖ Devolu√ß√£o: 23/07 √†s 10:00
üìç Local: Aeroporto
‚è±Ô∏è 12 di√°rias

*üöô VE√çCULO:*
Categoria: Econ√¥mico
Modelo: Volkswagen Gol ou similar
‚úÖ Ar condicionado
‚úÖ Dire√ß√£o hidr√°ulica
‚úÖ C√¢mbio manual
‚úÖ 5 pessoas
‚úÖ 2 malas grandes

*üí∞ VALORES:*
Di√°rias: R$ 1.200,00
Prote√ß√µes: R$ 180,00
Taxas: R$ 120,00

üí∞ Total: R$ 1.500,00
üí≥ 10x de R$ 150,00 s/ juros no cart√£o

*‚úÖ INCLU√çDO:*
‚Ä¢ Km livre
‚Ä¢ Prote√ß√£o b√°sica
‚Ä¢ Taxas e servi√ßos inclusos

*‚ùå N√ÉO INCLU√çDO:*
‚Ä¢ Combust√≠vel
‚Ä¢ Ped√°gios
‚Ä¢ Multas

*üìã DOCUMENTA√á√ÉO:*
‚Ä¢ CNH v√°lida (m√≠nimo 2 anos)
‚Ä¢ Cart√£o de cr√©dito (cau√ß√£o)
‚Ä¢ Idade m√≠nima: 21 anos

üîó https://www.cvc.com.br/carrinho-dinamico/carro

Valores sujeitos a confirma√ß√£o e disponibilidade (v${CONFIG.VERSION})`;
}

// 10. DICAS WHATSAPP
function gerarDicasWhatsApp(destino, criancas) {
    const temCrianca = parseInt(criancas) > 0;
    
    return `üí° *DICAS PARA ${destino.toUpperCase()}*

üåü *Sobre ${destino}*
Uma cidade encantadora que combina hist√≥ria milenar com modernidade vibrante. Com seus bondes hist√≥ricos, miradouros deslumbrantes e gastronomia excepcional!

üéØ *PRINCIPAIS PASSEIOS:*
1. *Mosteiro dos Jer√≥nimos* - Patrim√¥nio UNESCO
2. *Torre de Bel√©m* - S√≠mbolo de Lisboa
3. *Bairro de Alfama* - Cora√ß√£o tradicional com fado
4. *Tram 28* - Passeio pelos bairros hist√≥ricos
5. *Sintra* - Pal√°cio da Pena (bate-volta)

üå°Ô∏è *CLIMA EM JULHO:*
Perfeito! Entre 18¬∞C e 28¬∞C, muito sol
Leve: roupas leves, protetor solar, casaco leve para noite

${temCrianca ? `üë∂ *COM CRIAN√áA:*
‚Ä¢ Ocean√°rio de Lisboa (2¬∫ maior da Europa!)
‚Ä¢ Pavilh√£o do Conhecimento (museu interativo)
‚Ä¢ Telecabine do Parque das Na√ß√µes
‚Ä¢ Past√©is de Bel√©m s√£o imperd√≠veis!

` : ''}üí∞ *INFORMA√á√ïES √öTEIS:*
‚Ä¢ Moeda: Euro (‚Ç¨) - cart√£o aceito em todo lugar
‚Ä¢ Idioma: Portugu√™s - comunica√ß√£o f√°cil!
‚Ä¢ Documento: RG ou Passaporte
‚Ä¢ Seguro: Obrigat√≥rio (Tratado Schengen)

üõ°Ô∏è *SEGURO VIAGEM:*
Altamente recomendado! Garante tranquilidade total para emerg√™ncias m√©dicas, bagagem extraviada e cancelamentos.

üéÅ *PRODUTOS CVC RECOMENDADOS:*
‚úÖ Seguro viagem completo
‚úÖ Chip internacional
‚úÖ Passeios guiados em portugu√™s
‚úÖ Traslados privativos
‚úÖ Ingressos antecipados (evite filas!)

üí° *DICA DE OURO:*
Reserve tudo com anteced√™ncia para garantir disponibilidade e melhores pre√ßos. Nossa equipe est√° pronta para personalizar sua viagem!

${temCrianca ? `üìã *DOCUMENTA√á√ÉO PARA MENORES:*
Crian√ßas desacompanhadas de um ou ambos os pais precisam de autoriza√ß√£o judicial. Consulte nossos especialistas para orienta√ß√£o completa.` : ''}`;
}

// 11. RANKING DE HOT√âIS
function gerarRankingHoteis(destino, criancas) {
    const temCrianca = parseInt(criancas) > 0;
    
    return `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üèÜ *RANKING DOS HOT√âIS EM ${destino.toUpperCase()}*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

ü•á *1¬∫ LUGAR: Tivoli Oriente Lisboa*
üõèÔ∏è Quarto Superior: Vista para o rio Tejo
üìç Parque das Na√ß√µes, 8km do centro hist√≥rico (15 min de metr√¥)
   üìè 0.5km a p√© do Ocean√°rio
   üìè 1.2km a p√© do Telecabine
‚≠ê Avalia√ß√µes:
   ‚Ä¢ Booking: 8.4/10
   ‚Ä¢ Google: 4.2/5
   ‚Ä¢ TripAdvisor: 4.0/5
‚úÖ Destaques: Moderno, vista rio, pr√≥ximo ao Ocean√°rio, piscina

ü•à *2¬∫ LUGAR: Hotel Real Pal√°cio*
üõèÔ∏è Quarto Standard: Estilo cl√°ssico portugu√™s
üìç Centro Hist√≥rico, pr√≥ximo √† Pra√ßa do Com√©rcio
   üìè 200m do Tram 28
   üìè 500m do Castelo S√£o Jorge
‚≠ê Avalia√ß√µes:
   ‚Ä¢ Booking: 7.8/10
   ‚Ä¢ Google: 4.0/5
   ‚Ä¢ TripAdvisor: 3.5/5
‚úÖ Destaques: Centro hist√≥rico, pr√≥ximo a tudo a p√©
‚ö†Ô∏è *HOTEL SIMPLES - CATEGORIA ECON√îMICA*

ü•â *3¬∫ LUGAR: Memmo Alfama Hotel*
üõèÔ∏è Quarto com Varanda: Vista panor√¢mica da cidade
üìç Alfama, 2km do centro hist√≥rico
   üìè 100m da S√© Catedral
   üìè 300m do Miradouro
‚≠ê Avalia√ß√µes:
   ‚Ä¢ Booking: 9.1/10
   ‚Ä¢ Google: 4.5/5
   ‚Ä¢ TripAdvisor: 4.5/5
‚úÖ Destaques: Boutique hotel, terra√ßo com piscina, vista incr√≠vel

üí° *MINHA RECOMENDA√á√ÉO:*
Para sua viagem, recomendo o *Tivoli Oriente* pela excelente localiza√ß√£o e estrutura completa.

${temCrianca ? `üë∂ *DICA PARA FAM√çLIAS:*
O Tivoli Oriente oferece quartos familiares espa√ßosos e kids club.
Fica pr√≥ximo ao Ocean√°rio e Pavilh√£o do Conhecimento.` : ''}

üìå *OBSERVA√á√ïES:*
‚Ä¢ Pre√ßos variam conforme temporada
‚Ä¢ Reserve com anteced√™ncia para garantir disponibilidade
‚Ä¢ Consulte condi√ß√µes de cancelamento
‚Ä¢ Avalia√ß√µes coletadas em 08/2025`;
}

// ================================================================================
// HANDLER PRINCIPAL
// ================================================================================

module.exports = async function handler(req, res) {
    console.log(`[${getTimestamp()}] === CVC v${CONFIG.VERSION} INICIANDO ===`);
    
    // Headers CORS
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
    
    // OPTIONS request
    if (req.method === 'OPTIONS') {
        res.status(200).end();
        return;
    }
    
    // GET request - Status
    if (req.method === 'GET') {
        res.status(200).json({
            success: true,
            status: 'operational',
            version: CONFIG.VERSION,
            message: 'CVC Itaqua v2.89 - Sistema Funcionando!'
        });
        return;
    }
    
    // Validar m√©todo POST
    if (req.method !== 'POST') {
        res.status(405).json({
            success: false,
            error: 'M√©todo n√£o permitido'
        });
        return;
    }
    
    try {
        // Extrair dados
        const {
            observacoes = '',
            textoColado = '',
            destino = '',
            adultos = '',
            criancas = 0,
            tipos = [],
            parcelamento = '',
            imagemBase64 = null,
            pdfContent = null
        } = req.body;
        
        const conteudo = observacoes || textoColado || pdfContent || '';
        console.log(`[${getTimestamp()}] Processando: ${conteudo.length} caracteres`);
        
        // Detectar destino e passageiros
        const destinoFinal = extrairDestino(conteudo, destino);
        const passageiros = adultos ? 
            `${String(adultos).padStart(2, '0')} adultos${criancas > 0 ? ` + ${String(criancas).padStart(2, '0')} crian√ßa${criancas > 1 ? 's' : ''}` : ''}` : 
            '02 adultos';
        
        // DICAS
        if (conteudo.includes('GERE DICAS') || tipos.includes('Dicas')) {
            const resultado = gerarDicasWhatsApp(destinoFinal, criancas);
            res.status(200).json({
                success: true,
                result: resultado,
                metadata: { tipo: 'dicas', version: CONFIG.VERSION }
            });
            return;
        }
        
        // RANKING
        if (conteudo.includes('GERE RANKING') || tipos.includes('Ranking')) {
            const resultado = gerarRankingHoteis(destinoFinal, criancas);
            res.status(200).json({
                success: true,
                result: resultado,
                metadata: { tipo: 'ranking', version: CONFIG.VERSION }
            });
            return;
        }
        
        // OR√áAMENTOS
        const tipo = detectarTipoOrcamento(conteudo, tipos);
        console.log(`[${getTimestamp()}] Tipo detectado: ${tipo}`);
        
        let resultado;
        
        switch (tipo) {
            case 'AEREO_SIMPLES':
                resultado = processarAereoSimples(conteudo, destinoFinal, passageiros);
                break;
            case 'MULTIPLAS_OPCOES':
                resultado = processarMultiplasOpcoes(conteudo, destinoFinal, passageiros);
                break;
            case 'MULTITRECHO':
                resultado = processarMultitrecho(conteudo, destinoFinal, passageiros);
                break;
            case 'PACOTE_COMPLETO':
                resultado = processarPacoteCompleto(conteudo, destinoFinal, passageiros);
                break;
            case 'CRUZEIRO':
                resultado = processarCruzeiro(conteudo, destinoFinal, passageiros);
                break;
            case 'SOMENTE_HOTEL':
                resultado = processarSomenteHotel(conteudo, destinoFinal, passageiros);
                break;
            case 'INGRESSOS':
                resultado = processarIngressos(conteudo, destinoFinal);
                break;
            case 'SEGURO_VIAGEM':
                resultado = processarSeguroViagem(conteudo, destinoFinal);
                break;
            case 'LOCACAO_CARRO':
                resultado = processarLocacaoCarro(conteudo, destinoFinal);
                break;
            default:
                resultado = processarAereoSimples(conteudo, destinoFinal, passageiros);
        }
        
        console.log(`[${getTimestamp()}] ‚úÖ Processamento conclu√≠do`);
        
        res.status(200).json({
            success: true,
            result: resultado,
            metadata: {
                tipo: tipo,
                destino: destinoFinal,
                version: CONFIG.VERSION
            }
        });
        
    } catch (error) {
        console.error(`[${getTimestamp()}] ‚ùå Erro:`, error);
        res.status(500).json({
            success: false,
            error: error.message || 'Erro interno do servidor',
            version: CONFIG.VERSION
        });
    }
};

// Log de inicializa√ß√£o
console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
console.log('‚ïë         CVC ITAQUA v2.89 - SISTEMA COMPLETO                    ‚ïë');
console.log('‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£');
console.log('‚ïë ‚úÖ Todos os 11 produtos funcionando                            ‚ïë');
console.log('‚ïë ‚úÖ Templates completos mantidos                                ‚ïë');
console.log('‚ïë ‚úÖ Dicas e Rankings completos                                  ‚ïë');
console.log('‚ïë ‚úÖ Arquivo: api/ai-google.js                                   ‚ïë');
console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
