// api/ai-google.js - HANDLER PRINCIPAL CORRIGIDO v4.0
// ================================================================================
// üéØ ARQUIVO PRINCIPAL COM TODOS OS PROCESSADORES INTEGRADOS
// üõ°Ô∏è GARANTE JSON V√ÅLIDO EM 100% DOS CASOS + APLICA TODAS AS CORRE√á√ïES
// ================================================================================

import { safeJSONResponse } from './core/json-response.js';
import { SYSTEM_CONFIG } from './data/constants.js';
import { extrairDadosCompletos } from './detectors/data-extractor.js';
import { detectarTipoProduto } from './detectors/product-detector.js';
import { detectarHotel } from './detectors/hotel-detector.js';
import { processarDatas } from './processors/date-processor.js';
import { processarAeroportos } from './processors/airport-processor.js';
import { processarBagagem } from './processors/baggage-processor.js';
import { processarPrecos } from './processors/price-processor.js';
import { processarFormatacaoFinal } from './processors/format-processor.js';
import { construirPrompt } from './prompts/prompt-builder.js';

// ================================================================================
// üß† HANDLER PRINCIPAL
// ================================================================================

export default async function handler(req, res) {
    const startTime = Date.now();
    const requestId = generateRequestId();
    
    // üõ°Ô∏è GARANTIA ABSOLUTA DE JSON V√ÅLIDO
    try {
        console.log(`üöÄ [${requestId}] Iniciando processamento v${SYSTEM_CONFIG.VERSION}`);
        
        // 1. Configurar headers de seguran√ßa
        setupSecurityHeaders(res);
        
        // 2. Validar m√©todo HTTP
        if (req.method === 'OPTIONS') {
            return safeJSONResponse(res, true, 'CORS OK', null, { requestId });
        }
        
        if (req.method === 'GET') {
            return safeJSONResponse(res, true, getSystemStatus(), null, {
                requestId,
                version: SYSTEM_CONFIG.VERSION,
                uptime: Date.now() - startTime
            });
        }
        
        if (req.method !== 'POST') {
            return safeJSONResponse(res, false, 'M√©todo n√£o permitido', 'Use POST', { requestId });
        }
        
        // 3. Extrair e validar dados
        const body = req.body || {};
        const {
            observacoes = '',
            textoColado = '',
            destino = '',
            adultos = 1,
            criancas = 0,
            tipos = [],
            parcelamento = '',
            imagemBase64 = null,
            pdfContent = null
        } = body;
        
        // 4. Combinar conte√∫do principal
        const conteudoPrincipal = (observacoes || textoColado || pdfContent || '').toString();
        
        // 5. Validar entrada
        if (!conteudoPrincipal.trim() && !imagemBase64) {
            return safeJSONResponse(res, false, 'Adicione informa√ß√µes sobre a viagem', 
                'Por favor, adicione informa√ß√µes sobre a viagem', { requestId });
        }
        
        console.log(`üìã [${requestId}] Conte√∫do recebido: ${conteudoPrincipal.length} caracteres`);
        
        // 6. FASE DE DETEC√á√ÉO
        console.log(`üîç [${requestId}] Iniciando fase de detec√ß√£o...`);
        
        // Extrair dados do conte√∫do
        const dadosExtraidos = extrairDadosCompletos(conteudoPrincipal);
        console.log(`üìä [${requestId}] Dados extra√≠dos:`, dadosExtraidos);
        
        // Detectar se √© hotel
        const resultadoHotel = detectarHotel(conteudoPrincipal, tipos);
        console.log(`üè® [${requestId}] Detec√ß√£o hotel:`, resultadoHotel);
        
        // Detectar tipo de produto
        const tipoDetectado = detectarTipoProduto(conteudoPrincipal, tipos, resultadoHotel);
        console.log(`üéØ [${requestId}] Tipo detectado: ${tipoDetectado}`);
        
        // Formatar passageiros
        let passageiros = dadosExtraidos.passageiros;
        if (!passageiros) {
            const numAdultos = parseInt(adultos) || 1;
            const numCriancas = parseInt(criancas) || 0;
            passageiros = `${String(numAdultos).padStart(2, '0')} adulto${numAdultos > 1 ? 's' : ''}`;
            if (numCriancas > 0) {
                passageiros += ` + ${String(numCriancas).padStart(2, '0')} crian√ßa${numCriancas > 1 ? 's' : ''}`;
            }
        }
        
        console.log(`üë• [${requestId}] Passageiros: ${passageiros}`);
        
        // 7. FASE DE GERA√á√ÉO COM IA
        console.log(`üß† [${requestId}] Iniciando fase de gera√ß√£o...`);
        
        // Construir prompt contextual
        const contextoPrompt = {
            conteudoPrincipal,
            tipoOrcamento: tipoDetectado,
            passageiros,
            destino: dadosExtraidos.destino || destino,
            ehImagem: !!imagemBase64,
            iaDestino: decidirIA(conteudoPrincipal, tipoDetectado, imagemBase64),
            dadosExtraidos
        };
        
        const prompt = construirPrompt(contextoPrompt);
        console.log(`üìù [${requestId}] Prompt constru√≠do: ${prompt.length} caracteres`);
        
        // Processar com IA
        let resultado = '';
        let iaUsada = 'none';
        
        try {
            if (contextoPrompt.iaDestino === 'claude' && process.env.ANTHROPIC_API_KEY) {
                console.log(`üîÆ [${requestId}] Usando Claude...`);
                resultado = await processarComClaude(prompt, imagemBase64);
                iaUsada = 'claude';
            } else if (process.env.OPENAI_API_KEY) {
                console.log(`‚ö° [${requestId}] Usando GPT-4o-mini...`);
                resultado = await processarComGPT(prompt);
                iaUsada = 'gpt';
            } else {
                throw new Error('Nenhuma API de IA configurada');
            }
            
            console.log(`‚úÖ [${requestId}] IA processou: ${resultado.length} caracteres`);
            
        } catch (iaError) {
            console.error(`‚ùå [${requestId}] Erro IA:`, iaError);
            return safeJSONResponse(res, false, 'Erro ao processar com IA', 
                `Erro: ${iaError.message}`, { requestId, ia_usada: 'error' });
        }
        
        // 8. FASE DE P√ìS-PROCESSAMENTO (TODAS AS CORRE√á√ïES)
        console.log(`üîß [${requestId}] Iniciando p√≥s-processamento completo...`);
        
        if (resultado && typeof resultado === 'string') {
            // Limpar formata√ß√£o markdown inicial
            resultado = resultado.replace(/```[\w]*\n?/g, '').replace(/```/g, '').trim();
            
            try {
                // APLICAR TODOS OS PROCESSADORES EM SEQU√äNCIA
                console.log(`üìÖ [${requestId}] Processando datas...`);
                resultado = processarDatas(resultado);
                
                console.log(`‚úàÔ∏è [${requestId}] Processando aeroportos...`);
                resultado = await processarAeroportos(resultado, conteudoPrincipal);
                
                console.log(`üéí [${requestId}] Processando bagagem...`);
                resultado = processarBagagem(resultado, dadosExtraidos);
                
                console.log(`üí∞ [${requestId}] Processando pre√ßos...`);
                resultado = processarPrecos(resultado, parcelamento, dadosExtraidos);
                
                console.log(`üîß [${requestId}] Processando formata√ß√£o final...`);
                resultado = processarFormatacaoFinal(resultado, dadosExtraidos);
                
                console.log(`‚úÖ [${requestId}] P√≥s-processamento completo!`);
                
            } catch (procError) {
                console.error(`‚ö†Ô∏è [${requestId}] Erro no p√≥s-processamento:`, procError);
                // Continuar mesmo com erro de processamento
            }
        }
        
        // 9. RESPOSTA FINAL
        const tempoTotal = Date.now() - startTime;
        console.log(`üéâ [${requestId}] Processamento completo em ${tempoTotal}ms`);
        
        return safeJSONResponse(res, true, resultado || 'Erro ao processar or√ßamento', null, {
            requestId,
            version: SYSTEM_CONFIG.VERSION,
            tipo_detectado: tipoDetectado,
            passageiros: passageiros,
            parcelamento_aplicado: parcelamento || 'nenhum',
            ia_usada: iaUsada,
            tempo_processamento: `${tempoTotal}ms`,
            processadores_aplicados: ['dates', 'airports', 'baggage', 'prices', 'format']
        });
        
    } catch (error) {
        console.error(`üí• [${requestId}] Erro geral:`, error);
        
        return safeJSONResponse(res, false, 'Erro interno do servidor', 
            'Erro interno. Tente novamente.', { 
                requestId, 
                error: error.message,
                stack: process.env.NODE_ENV === 'development' ? error.stack : undefined
            });
    }
}

// ================================================================================
// ü§ñ PROCESSAMENTO COM IAS
// ================================================================================

async function processarComClaude(prompt, imagemBase64) {
    const requestBody = {
        model: 'claude-3-haiku-20240307',
        max_tokens: 3000,
        temperature: 0.1,
        messages: [{
            role: 'user',
            content: imagemBase64 ? [
                { type: 'text', text: prompt },
                {
                    type: 'image',
                    source: {
                        type: 'base64',
                        media_type: imagemBase64.split(';')[0].split(':')[1],
                        data: imagemBase64.split(',')[1]
                    }
                }
            ] : prompt
        }]
    };
    
    const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
            'x-api-key': process.env.ANTHROPIC_API_KEY,
            'anthropic-version': '2023-06-01',
            'content-type': 'application/json'
        },
        body: JSON.stringify(requestBody)
    });
    
    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Claude erro ${response.status}: ${errorText}`);
    }
    
    const data = await response.json();
    return data.content[0].text;
}

async function processarComGPT(prompt) {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [
                { 
                    role: 'system', 
                    content: `Voc√™ √© um assistente da CVC. Formate or√ßamentos seguindo EXATAMENTE as instru√ß√µes. N√ÉO INVENTE informa√ß√µes que n√£o estejam no texto fornecido. Use apenas informa√ß√µes expl√≠citas no conte√∫do.` 
                },
                { role: 'user', content: prompt }
            ],
            temperature: 0.1,
            max_tokens: 3000
        })
    });
    
    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`OpenAI erro ${response.status}: ${errorText}`);
    }
    
    const data = await response.json();
    return data.choices[0].message.content;
}

// ================================================================================
// üéØ DECIS√ÉO DE IA
// ================================================================================

function decidirIA(conteudo, tipo, imagemBase64) {
    // Usar Claude para casos complexos
    if (imagemBase64 || 
        conteudo.length > 3000 ||
        tipo === 'PACOTE_COMPLETO' ||
        tipo === 'MULTITRECHO' ||
        tipo === 'DICAS_DESTINO' ||
        tipo === 'RANKING_HOTEIS') {
        return 'claude';
    }
    
    // GPT para casos simples
    return 'gpt';
}

// ================================================================================
// üîß FUN√á√ïES UTILIT√ÅRIAS
// ================================================================================

function generateRequestId() {
    return Math.random().toString(36).substr(2, 9);
}

function setupSecurityHeaders(res) {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
    res.setHeader('Content-Type', 'application/json');
}

function getSystemStatus() {
    return {
        status: 'operational',
        version: SYSTEM_CONFIG.VERSION,
        sistema: 'CVC ITAQUA',
        funcionalidades: [
            'Detec√ß√£o autom√°tica de tipos',
            'Processamento com m√∫ltiplas IAs',
            'P√≥s-processamento completo',
            'Valida√ß√£o autom√°tica',
            'JSON sempre v√°lido'
        ],
        processadores: [
            'date-processor',
            'airport-processor', 
            'baggage-processor',
            'price-processor',
            'format-processor'
        ],
        apis_configuradas: {
            claude: !!process.env.ANTHROPIC_API_KEY,
            openai: !!process.env.OPENAI_API_KEY
        }
    };
}

// ================================================================================
// üìã LOG DE INICIALIZA√á√ÉO
// ================================================================================

console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
console.log('‚ïë              CVC ITAQUA v4.0 - SISTEMA COMPLETO               ‚ïë');
console.log('‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£');
console.log('‚ïë ‚úÖ Handler principal com todos os processadores               ‚ïë');
console.log('‚ïë ‚úÖ P√≥s-processamento autom√°tico GARANTIDO                     ‚ïë');
console.log('‚ïë ‚úÖ Corre√ß√µes: datas, aeroportos, bagagem, pre√ßos, formato     ‚ïë');
console.log('‚ïë ‚úÖ JSON sempre v√°lido mesmo em crash total                    ‚ïë');
console.log('‚ïë ‚úÖ Logs detalhados para debugging                             ‚ïë');
console.log('‚ïë ‚úÖ Suporte a Claude + GPT com fallbacks                       ‚ïë');
console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
console.log(`üöÄ Sistema v${SYSTEM_CONFIG.VERSION} pronto para produ√ß√£o!`);
